name: Build Windows App

on:
  push:
    branches: ['*']
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Clean and install frontend dependencies
        run: |
          Remove-Item -Recurse -Force node_modules -ErrorAction SilentlyContinue
          Remove-Item -Force package-lock.json -ErrorAction SilentlyContinue
          npm install
        working-directory: frontend
        shell: pwsh

      - name: Build frontend
        run: npm run build
        working-directory: frontend

      - name: Install backend dependencies
        run: |
          pip install -r requirements.txt
          pip install pyinstaller
        working-directory: backend

      - name: Create launcher script
        shell: python
        run: |
          import os
          launcher = os.path.join("backend", "rateshop_launcher.py")
          with open(launcher, "w", encoding="utf-8") as f:
              f.write('''import os, sys, threading, time

          if getattr(sys, 'frozen', False):
              BASE_DIR = sys._MEIPASS
          else:
              BASE_DIR = os.path.dirname(os.path.abspath(__file__))

          sys.path.insert(0, os.path.join(BASE_DIR, "backend"))
          os.chdir(os.path.join(BASE_DIR, "backend"))

          import database
          if getattr(sys, 'frozen', False):
              database.DB_PATH = os.path.join(os.path.dirname(sys.executable), "rateshop.db")

          database.init_db()

          from seed_data import seed
          seed()

          def start_server():
              import uvicorn
              from main import app
              uvicorn.run(app, host="127.0.0.1", port=8000)

          server_thread = threading.Thread(target=start_server, daemon=True)
          server_thread.start()

          time.sleep(1)

          import webview
          webview.create_window("RateShop", "http://127.0.0.1:8000", width=1280, height=800)
          webview.start(gui="edgechromium")
          ''')

      - name: Build with PyInstaller
        run: |
          pyinstaller --name=RateShop --onedir --windowed ^
            --add-data="../frontend/dist;frontend/dist" ^
            --add-data=".;backend" ^
            --hidden-import=uvicorn.logging ^
            --hidden-import=uvicorn.loops ^
            --hidden-import=uvicorn.loops.auto ^
            --hidden-import=uvicorn.protocols ^
            --hidden-import=uvicorn.protocols.http ^
            --hidden-import=uvicorn.protocols.http.auto ^
            --hidden-import=uvicorn.protocols.websockets ^
            --hidden-import=uvicorn.protocols.websockets.auto ^
            --hidden-import=uvicorn.lifespan ^
            --hidden-import=uvicorn.lifespan.on ^
            --hidden-import=uvicorn.lifespan.off ^
            --hidden-import=webview ^
            --hidden-import=webview.platforms.edgechromium ^
            --hidden-import=proxy_tools ^
            --collect-all=fastapi ^
            --collect-all=starlette ^
            --collect-all=webview ^
            --collect-all=proxy_tools ^
            rateshop_launcher.py
        working-directory: backend
        shell: cmd

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: RateShop-Windows
          path: backend/dist/RateShop/
          compression-level: 9
